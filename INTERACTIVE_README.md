# 交互式自动化交易系统使用指南

## 功能特点

### 🎯 完整交互式操作流程
- ✅ **交易所选择**：支持币安（Binance）和欧易（OKX）
- ✅ **API配置**：手动输入API密钥，支持沙盒测试
- ✅ **实时行情**：显示合约列表和实时价格
- ✅ **交易标的选择**：从行情列表中选择交易对
- ✅ **策略参数配置**：手动输入各项策略参数
- ✅ **成本计算**：自动计算手续费、保证金、总成本
- ✅ **实时监控**：显示持仓、盈亏、交易日志
- ✅ **手动干预**：支持手动平仓、停止策略

## 快速开始

### 1. 启动程序

```bash
cd src
python interactive_main.py
```

### 2. 交互式操作流程

程序启动后，会显示主菜单：

```
╔══════════════════════════════════════════════════════════╗
║                                                          ║
║           加密货币自动化交易系统 - 主菜单                  ║
║                                                          ║
╚══════════════════════════════════════════════════════════╝
```

选择 **🚀 启动新策略** 开始配置策略。

### 步骤 1/5: 选择交易所

```
请选择交易所:
> 币安 (Binance)
  欧易 (OKX)
```

使用方向键选择，回车确认。

### 步骤 2/5: 配置 API

程序会提示输入以下信息：

**币安 (Binance)**：
- API Key
- Secret
- 是否使用沙盒环境（测试）

**欧易 (OKX)**：
- API Key
- Secret
- Passphrase
- 是否使用沙盒环境（测试）

输入后，程序会自动测试连接。

### 步骤 3/5: 选择交易对

程序会显示热门交易对列表：

```
┏━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━┓
┃ 序号 ┃ 交易对     ┃ 最新价    ┃ 24h涨跌 ┃ 24h成交量 ┃
┡━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━┩
│ 1    │ BTC/USDT  │ $43250.00 │ +2.34%  │ N/A      │
│ 2    │ ETH/USDT  │ $2280.50  │ -1.23%  │ N/A      │
│ 3    │ BNB/USDT  │ $310.25   │ +0.56%  │ N/A      │
...
```

操作说明：
- 输入交易对序号选择
- 输入 `p` 上一页
- 输入 `n` 下一页
- 输入 `q` 返回

### 步骤 4/5: 配置策略参数

程序会提示输入以下参数：

| 参数 | 说明 | 示例 |
|------|------|------|
| 上涨阈值 | 价格上涨多少百分比触发（%） | 2 表示 2% |
| 下跌阈值 | 价格下跌多少百分比触发（%） | 2 表示 2% |
| 止损比例 | 止损百分比（%） | 5 表示 5% |
| 仓位大小 | 单个仓位的大小（USDT） | 100 |
| 杠杆倍数 | 杠杆倍数（1表示无杠杆） | 1 |
| 监控间隔 | 价格监控间隔（秒） | 1 |

### 步骤 5/5: 交易成本计算

程序会自动计算并显示交易成本：

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                    交易成本计算                       ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 项目           │ 金额/数量   │ 说明                  │
├────────────────┼─────────────┼───────────────────────┤
│ 持仓数量       │ 0.002312    │ 单边数量              │
│ 开仓手续费     │ $0.16       │ 双边，费率 0.0400%    │
│ 所需保证金     │ $100.00     │                      │
│ 预估平仓手续费 │ $0.16       │ 双边预估              │
│ 总成本         │ $0.32       │ 开仓+平仓             │
│ 成本占比       │ 0.32%       │ 总成本 / 保证金       │
└────────────────┴─────────────┴───────────────────────┘
```

确认后，策略开始执行。

## 策略监控界面

策略启动后，进入实时监控界面：

```
╔══════════════════════════════════════════════════════════╗
║    策略实时监控 - BINANCE - BTC/USDT                      ║
╠══════════════════════════════════════════════════════════╣
║                                                          ║
║  ┌──────┐  ┌──────────────────────────────────────────┐  ║
║  │ 价格 │  │  汇总                                      │  ║
║  │      │  │  总持仓数: 2                              │  ║
║  │BTC/US│  │  多单数量: 1                              │  ║
║  │T     │  │  空单数量: 1                              │  ║
║  │$43250│  │                                           │  ║
║  │.00   │  │  总已实现盈亏: $12.50                     │  ║
║  │      │  │  总未实现盈亏: -$5.23                     │  ║
║  │      │  │  总盈亏: $7.27                           │  ║
║  └──────┘  └──────────────────────────────────────────┘  ║
║                                                          ║
║  ┌──────────────────────┐  ┌──────────────┐              ║
║  │ 当前持仓 (2)         │  │ 操作菜单      │              ║
║  ├──────────────────────┤  ├──────────────┤              ║
║  │ 方向  开仓价  ...    │  │ [1] 查看详细 │              ║
║  │ LONG  $43200  ...    │  │     持仓      │              ║
║  │ SHORT $43300  ...    │  │ [2] 查看交易 │              ║
║  │                      │  │     日志      │              ║
║  └──────────────────────┘  │ [3] 手动平仓 │              ║
║                            │     (指定)    │              ║
║  ┌──────────────────────┐  │ [4] 停止策略 │              ║
║  │ 最近交易 (10)        │  │ [5] 刷新数据 │              ║
║  ├──────────────────────┤  │ [0] 退出监控 │              ║
║  │ 时间  操作  ...      │  └──────────────┘              ║
║  │ 10:23 OPEN LONG ...  │                               ║
║  │ 10:24 OPEN SHORT ... │                               ║
║  └──────────────────────┘                               ║
╚══════════════════════════════════════════════════════════╝
```

## 手动干预功能

### 查看详细持仓

选择 `[1]` 查看详细持仓信息，显示每个仓位的详细数据：

```
============================================================
仓位ID: 1
方向: long
开仓价格: $43200.00
当前价格: $43250.00
持仓数量: 0.002312
状态: open
开仓时间: 2025-01-15 10:23:45
============================================================
```

### 查看完整交易日志

选择 `[2]` 查看所有交易记录，包括：
- 开仓/平仓/止损操作
- 时间、价格、数量
- 盈亏金额

### 手动平仓

**平仓指定仓位** `[3]`：
1. 显示当前持仓列表
2. 输入要平仓的仓位编号
3. 确认后执行平仓

**平仓所有仓位** `[4]`：
1. 显示当前所有持仓
2. 确认后一次性平仓
3. 显示平仓结果和总盈亏

### 停止策略

选择 `[5]` 停止策略执行：
- 停止价格监控
- 保留未平仓仓位
- 返回主菜单

选择 `[0]` 完全退出程序：
- 停止策略
- 提示手动处理未平仓仓位

## 策略逻辑说明

### 对冲网格策略

**初始化**：
- 同时开一个多单和一个空单

**上涨触发**：
- 条件：价格 ≥ 多单成本价 × (1 + 上涨阈值)
- 操作：平仓多单 + 开新多单

**下跌触发**：
- 条件：价格 ≤ 空单成本价 × (1 - 下跌阈值)
- 操作：平仓空单 + 开新空单

**止损保护**：
- 多单止损：价格 ≤ 成本价 × (1 - 止损比例)
- 空单止损：价格 ≥ 成本价 × (1 + 止损比例)
- 操作：自动平仓止损

**亏损仓位处理**：
- 要么触发止损
- 要么价格回到盈利状态并达到阈值
- 否则一直持有

## 数据库查询

所有交易数据都存储在PostgreSQL数据库中：

### 查询持仓

```python
from storage.database.db import get_session
from storage.database.position_manager import PositionManager

db = get_session()
mgr = PositionManager()

# 获取所有未平仓仓位
positions = mgr.get_open_positions(db, exchange='binance', symbol='BTC/USDT')

db.close()
```

### 查询交易日志

```python
from storage.database.db import get_session
from storage.database.trade_log_manager import TradeLogManager

db = get_session()
mgr = TradeLogManager()

# 获取最近50条交易日志
logs = mgr.get_trade_logs(db, exchange='binance', symbol='BTC/USDT', limit=50)

db.close()
```

## 常见问题

### Q: 如何切换到沙盒环境？
A: 在配置API时，选择"是否使用沙盒环境"为"是"。

### Q: 手动平仓后，策略还会继续吗？
A: 是的，策略会继续运行，只会平掉指定的仓位。如果希望停止策略，选择"停止策略"选项。

### Q: 策略会自动平仓吗？
A: 只在触发止损时会自动平仓。其他情况需要手动操作。

### Q: 可以同时运行多个策略吗？
A: 当前版本不支持，建议每次只运行一个策略。如需运行多个策略，可以启动多个程序实例。

### Q: 如何查看详细的运行日志？
A: 查看 `trading.log` 文件，包含所有操作的详细日志。

## 安全建议

1. **API密钥安全**
   - 不要将API密钥分享给他人
   - 使用API密钥时限制IP白名单
   - 定期更换API密钥

2. **风险控制**
   - 首次使用建议在沙盒环境测试
   - 设置合理的止损比例
   - 控制仓位大小，避免过度杠杆
   - 定期查看持仓和盈亏

3. **监控告警**
   - 实时关注监控界面
   - 查看交易日志
   - 监控账户余额变化

## 技术支持

如有问题或建议，请提交 Issue 或 Pull Request。

## 免责声明

本程序仅供学习和研究使用，不构成投资建议。使用本程序进行交易的任何盈亏均由使用者自行承担。请在充分理解策略逻辑和风险的前提下谨慎使用。
