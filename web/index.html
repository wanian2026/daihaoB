<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦ä¿¡å·æ‰«æç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .signal-long { border-left: 4px solid #10b981; }
        .signal-short { border-left: 4px solid #ef4444; }
        .confidence-high { background: linear-gradient(90deg, #10b981 0%, transparent 100%); }
        .confidence-medium { background: linear-gradient(90deg, #f59e0b 0%, transparent 100%); }
        .confidence-low { background: linear-gradient(90deg, #6b7280 0%, transparent 100%); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-mono" x-data="scannerApp()" x-cloak>

<div class="max-w-7xl mx-auto p-6">
    <!-- æ ‡é¢˜æ  -->
    <div class="flex items-center justify-between mb-6 border-b border-gray-700 pb-4">
        <div>
            <h1 class="text-2xl font-bold">ğŸ¯ åˆçº¦ä¿¡å·æ‰«æç³»ç»Ÿ</h1>
            <p class="text-sm text-gray-400 mt-1">åŸºäº FVG å’ŒæµåŠ¨æ€§åˆ†æçš„æ™ºèƒ½äº¤æ˜“ä¿¡å·ï¼ˆå…¬å¼€APIç‰ˆï¼‰</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" :class="monitoringConnected ? 'bg-green-500 animate-pulse' : 'bg-gray-500'"></div>
                <span class="text-sm" x-text="monitoringConnected ? 'å®æ—¶ç›‘æµ‹ä¸­' : 'ç›‘æµ‹æ–­å¼€'"></span>
            </div>
        </div>
    </div>

    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="mb-6">
        <div class="flex gap-2">
            <button @click="currentMode = 'scan'"
                    :class="currentMode === 'scan' ? 'bg-blue-600' : 'bg-gray-700'"
                    class="px-6 py-2 text-white font-bold rounded">
                ğŸ“Š æ‰¹é‡æ‰«æ
            </button>
            <button @click="currentMode = 'monitor'"
                    :class="currentMode === 'monitor' ? 'bg-blue-600' : 'bg-gray-700'"
                    class="px-6 py-2 text-white font-bold rounded">
                ğŸ‘ï¸ å®æ—¶ç›‘æµ‹
            </button>
        </div>
    </div>

    <!-- æ‰¹é‡æ‰«ææ¨¡å¼ -->
    <div x-show="currentMode === 'scan'">

    <!-- äº¤æ˜“æ‰€å’Œå‘¨æœŸé€‰æ‹© -->
    <div class="mb-6 bg-gray-800 border border-gray-700 p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-bold mb-1">ğŸ¦ äº¤æ˜“æ‰€é…ç½®</h2>
                <p class="text-sm text-gray-400">é€‰æ‹©äº¤æ˜“æ‰€å’ŒKçº¿å‘¨æœŸ</p>
            </div>
            <div class="flex gap-2">
                <select x-model="selectedExchange" @change="testConnection()" class="bg-gray-700 border border-gray-600 px-3 py-2 text-sm text-white">
                    <option value="binance">å¸å®‰ (Binance)</option>
                </select>
                <select x-model="selectedTimeframe" class="bg-gray-700 border border-gray-600 px-3 py-2 text-sm text-white">
                    <option value="5m">5åˆ†é’Ÿ</option>
                    <option value="15m">15åˆ†é’Ÿ</option>
                    <option value="30m">30åˆ†é’Ÿ</option>
                    <option value="1h">1å°æ—¶</option>
                    <option value="4h">4å°æ—¶</option>
                    <option value="1d">1å¤©</option>
                    <option value="1w">1å‘¨</option>
                </select>
                <button @click="testConnection()" :disabled="testingConnection" class="px-4 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:bg-gray-600">
                    <span x-show="!testingConnection">ğŸ”Œ æµ‹è¯•è¿æ¥</span>
                    <span x-show="testingConnection">æµ‹è¯•ä¸­...</span>
                </button>
            </div>
        </div>
        <div x-show="connectionStatus.message" class="mt-3 p-3 rounded" :class="connectionStatus.connected ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'" x-text="connectionStatus.message"></div>
    </div>

    <!-- æ‰«ææ§åˆ¶ -->
    <div class="mb-6 bg-gray-800 border border-gray-700 p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-bold mb-1">ğŸ” æ‰«ææ§åˆ¶</h2>
                <p class="text-sm text-gray-400">æ‰«ææ‰€æœ‰åˆçº¦ï¼Œè¯†åˆ«äº¤æ˜“æœºä¼š</p>
            </div>
            <div class="flex gap-2">
                <select x-model="scanLimit" class="bg-gray-700 border border-gray-600 px-3 py-2 text-sm text-white">
                    <option :value="20">æ‰«æ 20 ä¸ªåˆçº¦</option>
                    <option :value="50">æ‰«æ 50 ä¸ªåˆçº¦</option>
                    <option :value="100">æ‰«æ 100 ä¸ªåˆçº¦</option>
                </select>
                <button @click="startScan()" :disabled="scanning" class="px-6 py-2 bg-green-600 text-white text-sm font-bold hover:bg-green-700 disabled:bg-gray-600">
                    <span x-show="!scanning">ğŸš€ å¼€å§‹æ‰«æ</span>
                    <span x-show="scanning">æ‰«æä¸­...</span>
                </button>
                <button @click="refreshScan()" :disabled="scanning" class="px-6 py-2 bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 disabled:bg-gray-600">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>
    </div>

    <!-- æ‰«æç»Ÿè®¡ -->
    <div class="grid grid-cols-5 gap-4 mb-6">
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
            <p class="text-xs text-gray-400 uppercase">å·²æ‰«æ</p>
            <p class="text-2xl font-bold mt-1" x-text="scanStats.scanned || 0"></p>
        </div>
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
            <p class="text-xs text-gray-400 uppercase">å‘ç°ä¿¡å·</p>
            <p class="text-2xl font-bold mt-1 text-green-500" x-text="signals.length || 0"></p>
        </div>
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
            <p class="text-xs text-gray-400 uppercase">æœ€é«˜ä¿¡å¿ƒ</p>
            <p class="text-2xl font-bold mt-1" x-text="scanStats.max_confidence ? scanStats.max_confidence.toFixed(1) + '%' : '-'"></p>
        </div>
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
            <p class="text-xs text-gray-400 uppercase">Kçº¿å‘¨æœŸ</p>
            <p class="text-2xl font-bold mt-1 text-blue-400" x-text="scanStats.timeframe || selectedTimeframe"></p>
        </div>
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
            <p class="text-xs text-gray-400 uppercase">æ‰«ææ—¶é—´</p>
            <p class="text-sm font-bold mt-1" x-text="scanStats.time || '-'"></p>
        </div>
    </div>
    </div>

    <!-- å®æ—¶ç›‘æµ‹æ¨¡å¼ -->
    <div x-show="currentMode === 'monitor'">
        <!-- æ·»åŠ ç›‘æµ‹åˆçº¦ -->
        <div class="mb-6 bg-gray-800 border border-gray-700 p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-bold mb-1">â• æ·»åŠ ç›‘æµ‹åˆçº¦</h2>
                    <p class="text-sm text-gray-400">è¾“å…¥åˆçº¦ç¬¦å·ï¼ŒæŒç»­ç›‘æµ‹å¤šå‘¨æœŸä¿¡å·</p>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" :class="monitoringConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></div>
                    <span class="text-sm" :class="monitoringConnected ? 'text-green-400' : 'text-red-400'" x-text="monitoringConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'"></span>
                </div>
            </div>

            <div class="flex gap-4">
                <input type="text" x-model="monitoringSymbol" placeholder="åˆçº¦ç¬¦å· (å¦‚ BTC/USDT)"
                       class="flex-1 bg-gray-700 border border-gray-600 px-4 py-2 text-white rounded">
                <select x-model="monitoringExchange" class="bg-gray-700 border border-gray-600 px-4 py-2 text-white rounded">
                    <option value="binance">å¸å®‰</option>
                </select>
                <button @click="addMonitoring()" :disabled="!monitoringSymbol || addingMonitoring"
                        class="px-6 py-2 bg-green-600 text-white font-bold hover:bg-green-700 disabled:bg-gray-600 rounded">
                    <span x-show="!addingMonitoring">â• æ·»åŠ ç›‘æµ‹</span>
                    <span x-show="addingMonitoring">æ·»åŠ ä¸­...</span>
                </button>
            </div>

            <!-- å‘¨æœŸé€‰æ‹© -->
            <div class="mt-4">
                <p class="text-sm text-gray-400 mb-2">ç›‘æµ‹å‘¨æœŸï¼ˆå¯å¤šé€‰ï¼‰ï¼š</p>
                <div class="flex flex-wrap gap-2">
                    <template x-for="tf in ['5m', '15m', '30m', '1h', '4h', '1d', '1w']">
                        <button @click="toggleTimeframe(tf)"
                                :class="selectedTimeframes.includes(tf) ? 'bg-blue-600' : 'bg-gray-700'"
                                class="px-3 py-1 text-sm text-white rounded"
                                x-text="tf"></button>
                    </template>
                </div>
            </div>
        </div>

        <!-- ç›‘æµ‹åˆ—è¡¨ -->
        <div class="mb-6 bg-gray-800 border border-gray-700 p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">ğŸ“‹ ç›‘æµ‹åˆ—è¡¨ (<span x-text="monitoringList.length"></span>)</h2>
                <button @click="refreshMonitoring()" class="text-sm text-blue-400 hover:text-blue-300">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <div x-show="monitoringList.length === 0" class="text-center py-8 text-gray-400">
                æš‚æ— ç›‘æµ‹åˆçº¦
            </div>

            <div x-show="monitoringList.length > 0" class="space-y-3">
                <template x-for="(item, index) in monitoringList" :key="index">
                    <div class="bg-gray-900 border border-gray-700 p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold" x-text="item.symbol"></h3>
                                <p class="text-sm text-gray-400 mt-1">
                                    å‘¨æœŸ: <span x-text="item.timeframes.join(', ')"></span>
                                </p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <p class="text-xs text-gray-400">ä¿¡å·æ•°é‡</p>
                                    <p class="text-xl font-bold text-green-400" x-text="item.signals_count || 0"></p>
                                </div>
                                <button @click="removeMonitoring(item.symbol)"
                                        class="px-4 py-2 bg-red-600 text-white text-sm hover:bg-red-700 rounded">
                                    âŒ ç§»é™¤
                                </button>
                            </div>
                        </div>

                        <!-- å®æ—¶ä¿¡å·æ˜¾ç¤º -->
                        <div x-show="monitoringSignals[item.symbol]" class="mt-4 pt-4 border-t border-gray-700">
                            <h4 class="text-sm font-bold mb-2">ğŸ“Š å®æ—¶ä¿¡å·</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <template x-for="(signal, tf) in monitoringSignals[item.symbol]" :key="tf">
                                    <div x-show="signal.has_signal"
                                         class="bg-gray-800 border p-3 rounded"
                                         :class="signal.direction === 'long' ? 'border-green-600' : 'border-red-600'">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-bold bg-blue-900 text-blue-300 px-2 py-1 rounded" x-text="tf"></span>
                                            <span class="text-sm font-bold px-2 py-1 rounded"
                                                  :class="signal.direction === 'long' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'"
                                                  x-text="signal.direction === 'long' ? 'åšå¤š' : 'åšç©º'"></span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div>
                                                <p class="text-gray-400 text-xs">å…¥åœº</p>
                                                <p class="font-bold" x-text="signal.entry_price.toFixed(6)"></p>
                                            </div>
                                            <div>
                                                <p class="text-gray-400 text-xs">æ­¢ç›ˆ</p>
                                                <p class="font-bold text-green-400" x-text="signal.take_profit ? signal.take_profit.toFixed(6) : '-'"></p>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-xs">
                                            <p class="text-gray-400">ä¿¡å¿ƒåº¦: <span class="font-bold" :class="signal.confidence >= 70 ? 'text-green-400' : 'text-yellow-400'" x-text="signal.confidence.toFixed(1) + '%'"></span></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- ä¿¡å·åˆ—è¡¨ -->
    <div>
        <h2 class="text-lg font-bold border-b border-gray-700 pb-1 mb-4">ğŸ“Š äº¤æ˜“ä¿¡å·</h2>

        <!-- æ— ä¿¡å·æç¤º -->
        <div x-show="!loading && signals.length === 0" class="bg-gray-800 border border-gray-700 p-12 rounded-lg text-center">
            <p class="text-gray-400 text-lg">æš‚æ— äº¤æ˜“ä¿¡å·</p>
            <p class="text-gray-500 text-sm mt-2">ç‚¹å‡»"å¼€å§‹æ‰«æ"å¼€å§‹å¯»æ‰¾äº¤æ˜“æœºä¼š</p>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div x-show="loading" class="bg-gray-800 border border-gray-700 p-12 rounded-lg text-center">
            <div class="animate-spin w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-400 text-lg" x-text="loadingMessage || 'æ‰«æä¸­...'"></p>
        </div>

        <!-- ä¿¡å·å¡ç‰‡åˆ—è¡¨ -->
        <div x-show="!loading && signals.length > 0" class="space-y-4">
            <template x-for="(signal, index) in signals" :key="index">
                <div class="bg-gray-800 border border-gray-700 p-5 rounded-lg hover:border-gray-600 transition-colors"
                     :class="signal.direction === 'long' ? 'signal-long' : 'signal-short'">

                    <!-- ä¿¡å·å¤´éƒ¨ -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl font-bold" x-text="signal.symbol"></span>
                            <span class="px-3 py-1 rounded text-xs font-bold bg-blue-900 text-blue-300" x-text="'ğŸ“Š ' + signal.timeframe"></span>
                            <span class="px-3 py-1 rounded text-xs font-bold"
                                  :class="signal.direction === 'long' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'"
                                  x-text="signal.direction === 'long' ? 'ğŸ“ˆ åšå¤š' : 'ğŸ“‰ åšç©º'"></span>
                            <span class="px-3 py-1 rounded text-xs font-bold"
                                  :class="signal.confidence >= 70 ? 'bg-green-900 text-green-300' : (signal.confidence >= 50 ? 'bg-yellow-900 text-yellow-300' : 'bg-gray-700 text-gray-300')"
                                  x-text="'ä¿¡å¿ƒåº¦: ' + signal.confidence.toFixed(1) + '%'"></span>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">ç›ˆäºæ¯”</p>
                            <p class="text-xl font-bold"
                               :class="signal.risk_reward_ratio >= 2 ? 'text-green-500' : 'text-yellow-500'"
                               x-text="signal.risk_reward_ratio ? '1:' + signal.risk_reward_ratio.toFixed(1) : '-'"></p>
                        </div>
                    </div>

                    <!-- ä»·æ ¼ä¿¡æ¯ -->
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400 uppercase">å…¥åœºä»·</p>
                            <p class="text-lg font-bold" x-text="signal.entry_price.toFixed(6)"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 uppercase">æ­¢ç›ˆä»·</p>
                            <p class="text-lg font-bold text-green-400" x-text="signal.take_profit ? signal.take_profit.toFixed(6) : '-'"></p>
                            <p class="text-xs text-blue-300 mt-1" x-show="signal.take_profit_reason" x-text="signal.take_profit_reason"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 uppercase">æ­¢æŸä»·</p>
                            <p class="text-lg font-bold text-red-400" x-text="signal.stop_loss ? signal.stop_loss.toFixed(6) : '-'"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 uppercase">äº¤æ˜“æ‰€</p>
                            <p class="text-lg font-bold" x-text="signal.exchange === 'okx' ? 'æ¬§æ˜“' : 'å¸å®‰'"></p>
                        </div>
                    </div>

                    <!-- ä¿¡å¿ƒåº¦æ¡ -->
                    <div class="mb-4">
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-500"
                                 :class="signal.confidence >= 70 ? 'bg-green-500' : (signal.confidence >= 50 ? 'bg-yellow-500' : 'bg-gray-500')"
                                 :style="'width: ' + signal.confidence + '%'"></div>
                        </div>
                    </div>

                    <!-- è¯¦ç»†ä¿¡æ¯æŠ˜å  -->
                    <div>
                        <button @click="toggleDetail(index)" class="text-sm text-blue-400 hover:text-blue-300">
                            <span x-text="showDetail[index] ? 'â–¼ æ”¶èµ·è¯¦æƒ…' : 'â–¶ æŸ¥çœ‹è¯¦æƒ…'"></span>
                        </button>

                        <div x-show="showDetail[index]" class="mt-4 p-4 bg-gray-900 rounded-lg">
                            <!-- FVG ä¿¡æ¯ -->
                            <div x-show="signal.fvg_info" class="mb-4">
                                <h3 class="text-sm font-bold mb-2">ğŸ“ FVG ä¿¡æ¯</h3>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-400">ç±»å‹</p>
                                        <p x-text="signal.fvg_info.type.toUpperCase()"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">ç¼ºå£èŒƒå›´</p>
                                        <p x-text="signal.fvg_info.gap_low.toFixed(6) + ' - ' + signal.fvg_info.gap_high.toFixed(6)"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">ç¼ºå£å¤§å°</p>
                                        <p x-text="signal.fvg_info.size.toFixed(6)"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- æµåŠ¨æ€§ä¿¡æ¯ -->
                            <div x-show="signal.liquidity_info" class="mb-4">
                                <h3 class="text-sm font-bold mb-2">ğŸ’§ æµåŠ¨æ€§åˆ†æ</h3>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-400">æµåŠ¨æ€§è¯„åˆ†</p>
                                        <p x-text="signal.liquidity_info.liquidity_score.toFixed(1) + '/100'"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">ä¹°å–ä¸å¹³è¡¡</p>
                                        <p :class="signal.liquidity_info.imbalance_ratio > 0 ? 'text-green-400' : 'text-red-400'"
                                           x-text="(signal.liquidity_info.imbalance_ratio * 100).toFixed(2) + '%'"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">æ·±åº¦æ¯”ä¾‹</p>
                                        <p x-text="(signal.liquidity_info.depth_ratio * 100).toFixed(1) + '%'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- ä¿¡å·åŸå›  -->
                            <div>
                                <h3 class="text-sm font-bold mb-2">ğŸ’¡ ä¿¡å·åŸå› </h3>
                                <p class="text-sm text-gray-300" x-text="signal.reason"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
    function scannerApp() {
        return {
            showDetail: {},
            scanning: false,
            loading: false,
            loadingMessage: '',
            testingConnection: false,
            selectedExchange: 'binance',
            selectedTimeframe: '1h',
            scanLimit: 50,
            signals: [],
            scanStats: {
                scanned: 0,
                max_confidence: 0,
                time: '',
                timeframe: ''
            },
            connectionStatus: {
                message: '',
                connected: false
            },

            // ç›‘æµ‹æ¨¡å¼ç›¸å…³
            currentMode: 'scan',  // 'scan' æˆ– 'monitor'
            monitoringConnected: false,
            monitoringSymbol: '',
            monitoringExchange: 'binance',
            selectedTimeframes: ['5m', '1h', '1d'],
            addingMonitoring: false,
            monitoringList: [],
            monitoringSignals: {},
            ws: null,

            // APIé…ç½®
            apiBaseUrl: 'http://127.0.0.1:8080',

            init() {
                this.testConnection();
                // å¯åŠ¨WebSocketè¿æ¥
                this.connectWebSocket();
            },

            async testConnection() {
                this.testingConnection = true;

                try {
                    const response = await fetch(this.apiBaseUrl + '/api/test-connection', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            exchange: this.selectedExchange,
                            timeframe: this.selectedTimeframe
                        })
                    });
                    const data = await response.json();

                    this.connectionStatus.connected = data.success;
                    this.connectionStatus.message = data.success ? 'è¿æ¥æˆåŠŸï¼' + (data.message ? ' ' + data.message : '') : 'è¿æ¥å¤±è´¥ï¼š' + data.message;
                } catch (error) {
                    this.connectionStatus.connected = false;
                    this.connectionStatus.message = 'è¿æ¥å¤±è´¥ï¼š' + error.message;
                } finally {
                    this.testingConnection = false;
                }
            },

            async startScan() {
                this.scanning = true;
                this.loading = true;
                this.loadingMessage = 'æ­£åœ¨æ‰«æåˆçº¦...';
                this.signals = [];

                try {
                    const response = await fetch(this.apiBaseUrl + '/api/scan?limit=' + this.scanLimit, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            exchange: this.selectedExchange,
                            timeframe: this.selectedTimeframe
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.signals = data.signals;
                        this.scanStats = data.stats;
                    } else {
                        alert('æ‰«æå¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('æ‰«æå¤±è´¥: ' + error.message);
                } finally {
                    this.scanning = false;
                    this.loading = false;
                }
            },

            async refreshScan() {
                await this.startScan();
            },

            toggleDetail(index) {
                this.$set(this.showDetail, index, !this.showDetail[index]);
            },

            // ===== ç›‘æµ‹æ¨¡å¼ç›¸å…³æ–¹æ³• =====

            connectWebSocket() {
                const wsUrl = 'ws://127.0.0.1:8080/ws/monitoring';

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('WebSocketè¿æ¥æˆåŠŸ');
                    this.monitoringConnected = true;
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.type === 'signal') {
                        // æ›´æ–°ä¿¡å·ç¼“å­˜
                        const symbol = data.symbol;
                        const timeframe = data.timeframe;
                        const signal = data.data;

                        if (!this.monitoringSignals[symbol]) {
                            this.monitoringSignals[symbol] = {};
                        }
                        this.monitoringSignals[symbol][timeframe] = signal;

                        // æç¤ºæœ‰æ–°ä¿¡å·
                        console.log(`æ–°ä¿¡å·: ${symbol} ${timeframe} ${signal.direction}`);
                    }
                };

                this.ws.onclose = () => {
                    console.log('WebSocketè¿æ¥æ–­å¼€');
                    this.monitoringConnected = false;

                    // 5ç§’åé‡æ–°è¿æ¥
                    setTimeout(() => {
                        this.connectWebSocket();
                    }, 5000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                };
            },

            async addMonitoring() {
                if (!this.monitoringSymbol) {
                    alert('è¯·è¾“å…¥åˆçº¦ç¬¦å·');
                    return;
                }

                this.addingMonitoring = true;

                try {
                    const response = await fetch(this.apiBaseUrl + '/api/monitoring/add', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            symbol: this.monitoringSymbol,
                            exchange: this.monitoringExchange,
                            timeframes: this.selectedTimeframes.length > 0 ? this.selectedTimeframes : ['5m', '1h', '1d']
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(data.message);
                        this.monitoringSymbol = '';
                        await this.refreshMonitoring();
                    } else {
                        alert('æ·»åŠ å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('æ·»åŠ å¤±è´¥: ' + error.message);
                } finally {
                    this.addingMonitoring = false;
                }
            },

            async removeMonitoring(symbol) {
                if (!confirm(`ç¡®å®šè¦ç§»é™¤ ${symbol} çš„ç›‘æµ‹å—ï¼Ÿ`)) {
                    return;
                }

                try {
                    const response = await fetch(this.apiBaseUrl + `/api/monitoring/remove?symbol=${encodeURIComponent(symbol)}`, {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(data.message);
                        await this.refreshMonitoring();
                    } else {
                        alert('ç§»é™¤å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('ç§»é™¤å¤±è´¥: ' + error.message);
                }
            },

            async refreshMonitoring() {
                try {
                    const response = await fetch(this.apiBaseUrl + '/api/monitoring/list');
                    const data = await response.json();

                    if (data.success) {
                        this.monitoringList = data.symbols;
                    } else {
                        alert('è·å–ç›‘æµ‹åˆ—è¡¨å¤±è´¥: ' + data.message);
                    }

                    // åŒæ—¶è·å–æœ€æ–°ä¿¡å·
                    const signalResponse = await fetch(this.apiBaseUrl + '/api/monitoring/signals');
                    const signalData = await signalResponse.json();

                    if (signalData.success) {
                        this.monitoringSignals = signalData.signals;
                    }
                } catch (error) {
                    console.error('åˆ·æ–°ç›‘æµ‹å¤±è´¥:', error);
                }
            },

            toggleTimeframe(tf) {
                const index = this.selectedTimeframes.indexOf(tf);
                if (index > -1) {
                    this.selectedTimeframes.splice(index, 1);
                } else {
                    this.selectedTimeframes.push(tf);
                }
            }
        };
    }
</script>

</body>
</html>
