<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .excel-table {
            border-collapse: collapse;
            width: 100%;
        }
        .excel-table th,
        .excel-table td {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            text-align: left;
        }
        .excel-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        .excel-table tr:hover td {
            background-color: #f9fafb;
        }
        .excel-table td {
            font-size: 13px;
        }
        .status-running {
            background-color: #10b981;
        }
        .status-stopped {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-white text-black font-mono" x-data="app()" x-cloak>

<div class="max-w-7xl mx-auto p-6">
    <!-- 标题栏 -->
    <div class="flex items-center justify-between mb-6 border-b-2 border-black pb-4">
        <div>
            <h1 class="text-2xl font-bold">交易系统</h1>
            <p class="text-sm text-gray-500 mt-1">加密货币自动化交易</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full"
                     :class="tradingStatus === 'running' ? 'bg-green-500' : 'bg-gray-400'"></div>
                <span class="text-sm" x-text="tradingStatus === 'running' ? '运行中' : '已停止'"></span>
            </div>
            <button @click="refreshData()" class="px-4 py-2 border border-gray-300 text-sm hover:bg-gray-50">
                刷新
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">总交易</p>
            <p class="text-2xl font-bold mt-1" x-text="performance.total_trades || 0"></p>
        </div>
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">总盈亏</p>
            <p class="text-2xl font-bold mt-1"
               :class="performance.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'"
               x-text="(performance.total_pnl || 0).toFixed(2) + ' USDT'"></p>
        </div>
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">胜率</p>
            <p class="text-2xl font-bold mt-1" x-text="(performance.win_rate * 100 || 0).toFixed(1) + '%'"></p>
        </div>
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">余额</p>
            <p class="text-2xl font-bold mt-1" x-text="balance.toFixed(2) + ' USDT'"></p>
        </div>
    </div>

    <!-- API配置 -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold border-b border-black pb-1">API配置</h2>
            <button @click="showApiConfig = !showApiConfig" class="text-sm text-gray-500" x-text="showApiConfig ? '收起' : '展开'">
            </button>
        </div>
        <div x-show="showApiConfig" class="border border-gray-300 p-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">交易所</label>
                    <select x-model="apiConfig.exchange" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option value="okx">欧易 (OKX)</option>
                        <option value="binance">币安 (Binance)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">测试网</label>
                    <select x-model="apiConfig.testnet" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option :value="true">是</option>
                        <option :value="false">否</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">API Key</label>
                    <input type="text" x-model="apiConfig.api_key" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="输入API Key">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">Secret</label>
                    <input type="password" x-model="apiConfig.secret" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="输入Secret">
                </div>
                <div x-show="apiConfig.exchange === 'okx'">
                    <label class="text-xs text-gray-600 uppercase block mb-1">Password</label>
                    <input type="password" x-model="apiConfig.password" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="输入Password">
                </div>
            </div>
            <button @click="saveApiConfig()" class="px-4 py-2 bg-black text-white text-sm hover:bg-gray-800">
                保存API配置
            </button>
        </div>
    </div>

    <!-- 策略配置表格 -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold border-b border-black pb-1">策略配置</h2>
            <button @click="showAddConfig = true" class="text-sm text-blue-600">+ 新增策略</button>
        </div>

        <div x-show="showAddConfig" class="border border-gray-300 p-4 mb-4">
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">交易所</label>
                    <select x-model="newConfig.exchange" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option value="okx">欧易 (OKX)</option>
                        <option value="binance">币安 (Binance)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">交易对</label>
                    <select x-model="newConfig.symbol" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option value="BTC/USDT">BTC/USDT</option>
                        <option value="ETH/USDT">ETH/USDT</option>
                        <option value="BNB/USDT">BNB/USDT</option>
                        <option value="SOL/USDT">SOL/USDT</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">上涨阈值(%)</label>
                    <input type="number" x-model.number="newConfig.long_threshold" step="0.1" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="2">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">下跌阈值(%)</label>
                    <input type="number" x-model.number="newConfig.short_threshold" step="0.1" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="2">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">止损比例(%)</label>
                    <input type="number" x-model.number="newConfig.stop_loss_ratio" step="0.1" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="5">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">杠杆</label>
                    <input type="number" x-model.number="newConfig.leverage" min="1" max="125" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="1">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">固定仓位(USDT)</label>
                    <input type="number" x-model.number="newConfig.position_size" step="10" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="留空使用比例">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">仓位比例(%)</label>
                    <input type="number" x-model.number="newConfig.position_ratio" step="1" min="1" max="100" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="20">
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="createConfig()" class="px-4 py-2 bg-black text-white text-sm hover:bg-gray-800">
                    保存策略
                </button>
                <button @click="showAddConfig = false" class="px-4 py-2 border border-gray-300 text-sm hover:bg-gray-50">
                    取消
                </button>
            </div>
        </div>

        <table class="excel-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>交易所</th>
                <th>交易对</th>
                <th>上涨阈值</th>
                <th>下跌阈值</th>
                <th>止损</th>
                <th>杠杆</th>
                <th>仓位</th>
                <th>现价</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="config in configs" :key="config.id">
                <tr>
                    <td x-text="config.id"></td>
                    <td x-text="config.exchange.toUpperCase()"></td>
                    <td x-text="config.symbol"></td>
                    <td x-text="(config.long_threshold * 100).toFixed(1) + '%'"></td>
                    <td x-text="(config.short_threshold * 100).toFixed(1) + '%'"></td>
                    <td x-text="(config.stop_loss_ratio * 100).toFixed(1) + '%'"></td>
                    <td x-text="config.leverage + 'x'"></td>
                    <td>
                        <span x-show="config.position_size" x-text="config.position_size + ' USDT'"></span>
                        <span x-show="!config.position_size" x-text="config.position_ratio + '%'"></span>
                    </td>
                    <td x-text="ticker[config.symbol] || '-'"></td>
                    <td>
                        <button @click="deleteConfig(config.id)" class="text-red-600 hover:underline text-xs">删除</button>
                    </td>
                </tr>
            </template>
            <tr x-show="configs.length === 0">
                <td colspan="11" class="text-center text-gray-400 py-4">暂无策略配置</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 交易控制 -->
    <div class="mb-6">
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">交易控制</h2>
        <div class="flex gap-4">
            <button @click="controlTrading('start')"
                    :disabled="tradingStatus === 'running'"
                    class="px-6 py-2 bg-green-600 text-white text-sm hover:bg-green-700 disabled:opacity-50">
                启动交易
            </button>
            <button @click="controlTrading('pause')"
                    :disabled="tradingStatus !== 'running'"
                    class="px-6 py-2 bg-yellow-600 text-white text-sm hover:bg-yellow-700 disabled:opacity-50">
                暂停交易
            </button>
            <button @click="controlTrading('resume')"
                    :disabled="tradingStatus !== 'paused'"
                    class="px-6 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-50">
                恢复交易
            </button>
            <button @click="controlTrading('stop')"
                    :disabled="tradingStatus === 'stopped'"
                    class="px-6 py-2 bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-50">
                停止交易
            </button>
        </div>
    </div>

    <!-- 持仓监控表格 -->
    <div class="mb-6">
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">持仓监控</h2>
        <table class="excel-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>交易对</th>
                <th>方向</th>
                <th>数量</th>
                <th>入场价</th>
                <th>现价</th>
                <th>盈亏</th>
                <th>盈亏%</th>
                <th>止损价</th>
                <th>开仓时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="pos in positions" :key="pos.id">
                <tr>
                    <td x-text="pos.id"></td>
                    <td x-text="pos.symbol"></td>
                    <td>
                        <span :class="pos.side === 'long' ? 'text-green-600' : 'text-red-600'" x-text="pos.side === 'long' ? '做多' : '做空'"></span>
                    </td>
                    <td x-text="pos.size.toFixed(4)"></td>
                    <td x-text="pos.entry_price.toFixed(2)"></td>
                    <td x-text="pos.current_price.toFixed(2)"></td>
                    <td :class="pos.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="pos.unrealized_pnl.toFixed(2) + ' USDT'"></td>
                    <td :class="pos.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="(pos.unrealized_pnl_pct * 100).toFixed(2) + '%'"></td>
                    <td x-text="pos.stop_loss ? pos.stop_loss.toFixed(2) : '-'"></td>
                    <td x-text="new Date(pos.created_at).toLocaleString()"></td>
                    <td>
                        <button @click="closePosition(pos.id)" class="text-red-600 hover:underline text-xs">平仓</button>
                    </td>
                </tr>
            </template>
            <tr x-show="positions.length === 0">
                <td colspan="12" class="text-center text-gray-400 py-4">暂无持仓</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 交易历史表格 -->
    <div class="mb-6">
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">交易历史</h2>
        <table class="excel-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>交易对</th>
                <th>方向</th>
                <th>类型</th>
                <th>价格</th>
                <th>数量</th>
                <th>盈亏</th>
                <th>手续费</th>
                <th>状态</th>
                <th>时间</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="trade in trades" :key="trade.id">
                <tr>
                    <td x-text="trade.id"></td>
                    <td x-text="trade.symbol"></td>
                    <td>
                        <span :class="trade.side === 'buy' ? 'text-green-600' : 'text-red-600'" x-text="trade.side === 'buy' ? '买入' : '卖出'"></span>
                    </td>
                    <td x-text="trade.order_type"></td>
                    <td x-text="trade.price.toFixed(2)"></td>
                    <td x-text="trade.quantity.toFixed(4)"></td>
                    <td :class="trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="trade.pnl ? trade.pnl.toFixed(2) + ' USDT' : '-'"></td>
                    <td x-text="trade.fee ? trade.fee.toFixed(4) + ' USDT' : '-'"></td>
                    <td>
                        <span x-show="trade.status === 'filled'" class="text-green-600">成交</span>
                        <span x-show="trade.status === 'pending'" class="text-yellow-600">待成交</span>
                        <span x-show="trade.status === 'cancelled'" class="text-red-600">已取消</span>
                        <span x-show="trade.status === 'failed'" class="text-red-600">失败</span>
                    </td>
                    <td x-text="new Date(trade.created_at).toLocaleString()"></td>
                </tr>
            </template>
            <tr x-show="trades.length === 0">
                <td colspan="11" class="text-center text-gray-400 py-4">暂无交易记录</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 市场行情 -->
    <div>
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">市场行情</h2>

        <!-- 搜索框 -->
        <div class="mb-4 flex gap-2">
            <select x-model="searchExchange" @change="loadAvailableSymbols()" class="border border-gray-300 px-3 py-2 text-sm">
                <option value="okx">欧易 (OKX)</option>
                <option value="binance">币安 (Binance)</option>
            </select>
            <div class="relative flex-1">
                <input
                    type="text"
                    x-model="searchSymbol"
                    @keyup.enter="searchTicker()"
                    @focus="showSymbolList = true"
                    placeholder="输入交易对名称，如: BTC/USDT"
                    class="w-full border border-gray-300 px-3 py-2 text-sm"
                >
                <!-- 交易对下拉列表 -->
                <div x-show="showSymbolList && availableSymbols.length > 0" class="absolute z-10 w-full bg-white border border-gray-300 mt-1 max-h-60 overflow-y-auto">
                    <template x-for="symbol in availableSymbols" :key="symbol">
                        <div
                            @click="selectSymbol(symbol)"
                            class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                            x-text="symbol"
                        ></div>
                    </template>
                </div>
            </div>
            <button @click="searchTicker()" class="px-4 py-2 bg-black text-white text-sm hover:bg-gray-800">
                搜索
            </button>
            <button @click="clearSearch()" class="px-4 py-2 border border-gray-300 text-sm hover:bg-gray-50">
                清空
            </button>
        </div>

        <!-- 搜索结果提示 -->
        <div x-show="searchResult" class="mb-4 p-3 bg-blue-50 border border-blue-200 text-sm">
            <span class="font-bold">搜索结果：</span>
            <span x-text="searchResult"></span>
        </div>

        <table class="excel-table">
            <thead>
            <tr>
                <th>交易对</th>
                <th>最新价</th>
                <th>24h涨跌</th>
                <th>24h涨跌幅</th>
                <th>24h成交量</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="(ticker, symbol) in marketTicker" :key="symbol">
                <tr>
                    <td x-text="symbol"></td>
                    <td x-text="ticker.price ? ticker.price.toFixed(2) : '-'"></td>
                    <td :class="ticker.change >= 0 ? 'text-green-600' : 'text-red-600'" x-text="ticker.change ? ticker.change.toFixed(2) : '-'"></td>
                    <td :class="ticker.change_percent >= 0 ? 'text-green-600' : 'text-red-600'" x-text="ticker.change_percent ? ticker.change_percent.toFixed(2) + '%' : '-'"></td>
                    <td x-text="ticker.volume ? ticker.volume.toFixed(2) : '-'"></td>
                </tr>
            </template>
            <tr x-show="Object.keys(marketTicker).length === 0">
                <td colspan="5" class="text-center text-gray-400 py-4">暂无行情数据</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    function app() {
        return {
            showApiConfig: false,
            showAddConfig: false,
            tradingStatus: 'stopped',
            balance: 0,
            positions: [],
            trades: [],
            configs: [],
            performance: {},
            ticker: {},
            marketTicker: {},
            searchExchange: 'okx',
            searchSymbol: '',
            searchResult: '',
            showSymbolList: false,
            availableSymbols: [],
            apiConfig: {
                exchange: 'okx',
                testnet: true,
                api_key: '',
                secret: '',
                password: ''
            },
            newConfig: {
                exchange: 'okx',
                symbol: 'BTC/USDT',
                long_threshold: 2,
                short_threshold: 2,
                stop_loss_ratio: 5,
                leverage: 1,
                position_size: null,
                position_ratio: 20
            },

            init() {
                this.loadConfigs();
                this.loadPerformance();
                this.loadPositions();
                this.loadTrades();
                this.loadBalance();
                this.loadApiConfig();
                this.checkTradingStatus();
                this.loadMarketTicker();
                this.loadAvailableSymbols();
                setInterval(() => this.refreshData(), 5000);
            },

            async loadApiConfig() {
                try {
                    const response = await fetch('/api/exchange/api-config');
                    const data = await response.json();
                    if (data.success && data.config) {
                        this.apiConfig = data.config;
                    }
                } catch (error) {
                    console.error('加载API配置失败:', error);
                }
            },

            async saveApiConfig() {
                try {
                    const response = await fetch('/api/exchange/api-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.apiConfig)
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('API配置保存成功');
                        this.showApiConfig = false;
                    } else {
                        alert('保存失败: ' + data.message);
                    }
                } catch (error) {
                    alert('保存失败: ' + error.message);
                }
            },

            async loadConfigs() {
                try {
                    const response = await fetch('/api/strategy/configs');
                    const data = await response.json();
                    if (data.success) {
                        this.configs = data.configs;
                        if (this.configs.length > 0) {
                            this.loadTicker();
                        }
                    }
                } catch (error) {
                    console.error('加载配置失败:', error);
                }
            },

            async loadPerformance() {
                try {
                    const response = await fetch('/api/performance');
                    const data = await response.json();
                    if (data.success) {
                        this.performance = data.performance;
                    }
                } catch (error) {
                    console.error('加载性能数据失败:', error);
                }
            },

            async loadPositions() {
                try {
                    const response = await fetch('/api/positions');
                    const data = await response.json();
                    if (data.success) {
                        this.positions = data.positions;
                    }
                } catch (error) {
                    console.error('加载持仓失败:', error);
                }
            },

            async loadTrades() {
                try {
                    const response = await fetch('/api/trades?limit=50');
                    const data = await response.json();
                    if (data.success) {
                        this.trades = data.trades;
                    }
                } catch (error) {
                    console.error('加载交易历史失败:', error);
                }
            },

            async loadBalance() {
                try {
                    if (this.configs.length > 0) {
                        const response = await fetch(`/api/exchange/balance/${this.configs[0].exchange}`);
                        const data = await response.json();
                        if (data.success && data.balance.USDT) {
                            this.balance = data.balance.USDT.free;
                        }
                    }
                } catch (error) {
                    console.error('加载余额失败:', error);
                }
            },

            async loadTicker() {
                for (const config of this.configs) {
                    try {
                        const response = await fetch(`/api/exchange/ticker/${config.exchange}/${config.symbol}`);
                        const data = await response.json();
                        if (data.success) {
                            this.ticker[config.symbol] = data.price;
                        }
                    } catch (error) {
                        console.error('加载行情失败:', error);
                    }
                }
            },

            async loadMarketTicker() {
                const symbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT'];
                for (const symbol of symbols) {
                    try {
                        const response = await fetch(`/api/exchange/ticker/okx/${symbol}`);
                        const data = await response.json();
                        if (data.success && data.ticker) {
                            this.marketTicker[symbol] = {
                                price: data.ticker.last,
                                change: data.ticker.change,
                                change_percent: data.ticker.percentage,
                                volume: data.ticker.volume
                            };
                        }
                    } catch (error) {
                        console.error('加载市场行情失败:', error);
                    }
                }
            },

            async searchTicker() {
                if (!this.searchSymbol.trim()) {
                    alert('请输入交易对名称');
                    return;
                }

                try {
                    const response = await fetch(`/api/exchange/ticker/${this.searchExchange}/${this.searchSymbol}`);
                    const data = await response.json();

                    if (data.success && data.ticker) {
                        // 清空现有行情
                        this.marketTicker = {};

                        // 显示搜索结果
                        this.marketTicker[this.searchSymbol] = {
                            price: data.ticker.last,
                            change: data.ticker.change,
                            change_percent: data.ticker.percentage,
                            volume: data.ticker.volume
                        };

                        this.searchResult = `成功获取 ${this.searchSymbol} 行情数据`;
                    } else {
                        this.searchResult = `搜索失败: ${data.message || '未知错误'}`;
                        alert('搜索失败: ' + (data.message || '未知错误'));
                    }
                } catch (error) {
                    this.searchResult = `搜索出错: ${error.message}`;
                    alert('搜索出错: ' + error.message);
                }
            },

            clearSearch() {
                this.searchSymbol = '';
                this.searchResult = '';
                this.loadMarketTicker();
            },

            async loadAvailableSymbols() {
                try {
                    const response = await fetch(`/api/exchange/symbols/${this.searchExchange}`);
                    const data = await response.json();
                    if (data.success) {
                        this.availableSymbols = data.symbols || [];
                        if (data.note) {
                            console.log(data.note);
                        }
                    }
                } catch (error) {
                    console.error('加载交易对列表失败:', error);
                }
            },

            selectSymbol(symbol) {
                this.searchSymbol = symbol;
                this.showSymbolList = false;
            },

            async checkTradingStatus() {
                try {
                    const response = await fetch('/api/trading/status');
                    const data = await response.json();
                    if (data.success) {
                        this.tradingStatus = data.status;
                    }
                } catch (error) {
                    console.error('检查交易状态失败:', error);
                }
            },

            async createConfig() {
                try {
                    const config = {
                        ...this.newConfig,
                        long_threshold: this.newConfig.long_threshold / 100,
                        short_threshold: this.newConfig.short_threshold / 100,
                        stop_loss_ratio: this.newConfig.stop_loss_ratio / 100
                    };

                    const response = await fetch('/api/strategy/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('策略保存成功');
                        this.showAddConfig = false;
                        this.loadConfigs();
                    } else {
                        alert('保存失败: ' + data.message);
                    }
                } catch (error) {
                    alert('保存失败: ' + error.message);
                }
            },

            async deleteConfig(id) {
                if (!confirm('确定删除此策略吗？')) return;

                try {
                    const response = await fetch(`/api/strategy/config/${id}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('删除成功');
                        this.loadConfigs();
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                } catch (error) {
                    alert('删除失败: ' + error.message);
                }
            },

            async closePosition(id) {
                if (!confirm('确定平仓吗？')) return;

                try {
                    const response = await fetch(`/api/positions/${id}/close`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('平仓成功');
                        this.loadPositions();
                        this.loadTrades();
                        this.loadPerformance();
                    } else {
                        alert('平仓失败: ' + data.message);
                    }
                } catch (error) {
                    alert('平仓失败: ' + error.message);
                }
            },

            async controlTrading(action) {
                try {
                    const response = await fetch('/api/trading/control', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ action })
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert(data.message);
                        this.checkTradingStatus();
                    } else {
                        alert('操作失败: ' + data.message);
                    }
                } catch (error) {
                    alert('操作失败: ' + error.message);
                }
            },

            refreshData() {
                this.loadPositions();
                this.loadTrades();
                this.loadPerformance();
                this.loadBalance();
                this.loadTicker();
                // 只在没有搜索时自动刷新市场行情
                if (!this.searchSymbol) {
                    this.loadMarketTicker();
                }
                this.checkTradingStatus();
            }
        };
    }
</script>

</body>
</html>
