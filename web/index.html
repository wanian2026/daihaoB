<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .excel-table {
            border-collapse: collapse;
            width: 100%;
        }
        .excel-table th,
        .excel-table td {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            text-align: left;
        }
        .excel-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        .excel-table tr:hover td {
            background-color: #f9fafb;
        }
        .excel-table td {
            font-size: 13px;
        }
        .status-running {
            background-color: #10b981;
        }
        .status-stopped {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-white text-black font-mono" x-data="app()" x-cloak>

<div class="max-w-7xl mx-auto p-6">
    <!-- æ ‡é¢˜æ  -->
    <div class="flex items-center justify-between mb-6 border-b-2 border-black pb-4">
        <div>
            <h1 class="text-2xl font-bold">äº¤æ˜“ç³»ç»Ÿ</h1>
            <p class="text-sm text-gray-500 mt-1">åŠ å¯†è´§å¸è‡ªåŠ¨åŒ–äº¤æ˜“</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full"
                     :class="tradingStatus === 'running' ? 'bg-green-500' : 'bg-gray-400'"></div>
                <span class="text-sm" x-text="tradingStatus === 'running' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'"></span>
            </div>
            <button @click="refreshData()" class="px-4 py-2 border border-gray-300 text-sm hover:bg-gray-50">
                åˆ·æ–°
            </button>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">æ€»äº¤æ˜“</p>
            <p class="text-2xl font-bold mt-1" x-text="performance.total_trades || 0"></p>
        </div>
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">æ€»ç›ˆäº</p>
            <p class="text-2xl font-bold mt-1"
               :class="performance.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'"
               x-text="(performance.total_pnl || 0).toFixed(2) + ' USDT'"></p>
        </div>
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">èƒœç‡</p>
            <p class="text-2xl font-bold mt-1" x-text="(performance.win_rate * 100 || 0).toFixed(1) + '%'"></p>
        </div>
        <div class="border border-gray-300 p-4">
            <p class="text-xs text-gray-500 uppercase">ä½™é¢</p>
            <p class="text-2xl font-bold mt-1" x-text="balance.toFixed(2) + ' USDT'"></p>
        </div>
    </div>

    <!-- APIé…ç½® -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold border-b border-black pb-1">è´¦æˆ·è¿æ¥</h2>
            <button @click="showApiConfig = !showApiConfig" class="text-sm text-gray-500" x-text="showApiConfig ? 'æ”¶èµ·' : 'å±•å¼€'">
            </button>
        </div>
        <div x-show="showApiConfig" class="border border-gray-300 p-4">
            <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
            <div x-show="connectionStatus.checked" class="mb-4 p-4 rounded" :class="connectionStatus.connected ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-3 h-3 rounded-full" :class="connectionStatus.connected ? 'bg-green-500' : 'bg-red-500'"></div>
                    <span class="font-bold" x-text="connectionStatus.connected ? 'å·²è¿æ¥' : 'è¿æ¥å¤±è´¥'"></span>
                </div>
                <div x-show="connectionStatus.message" class="text-sm" :class="connectionStatus.connected ? 'text-green-700' : 'text-red-700'" x-text="connectionStatus.message"></div>
                <!-- è´¦æˆ·ä¿¡æ¯ -->
                <div x-show="connectionStatus.connected && accountInfo" class="mt-3 pt-3 border-t border-green-200">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">å¯ç”¨ä½™é¢ï¼š</span>
                            <span class="font-bold" x-text="accountInfo.balance ? accountInfo.balance.toFixed(2) + ' USDT' : '-'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">è´¦æˆ·ç±»å‹ï¼š</span>
                            <span x-text="apiConfig.testnet ? 'æ¨¡æ‹Ÿäº¤æ˜“' : 'çœŸå®äº¤æ˜“'"></span>
                        </div>
                        <div x-show="accountInfo.total_equity">
                            <span class="text-gray-600">æ€»æƒç›Šï¼š</span>
                            <span x-text="accountInfo.total_equity ? accountInfo.total_equity.toFixed(2) + ' USDT' : '-'"></span>
                        </div>
                        <div x-show="accountInfo.unrealized_pnl">
                            <span class="text-gray-600">æœªå®ç°ç›ˆäºï¼š</span>
                            <span :class="accountInfo.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="accountInfo.unrealized_pnl ? accountInfo.unrealized_pnl.toFixed(2) + ' USDT' : '-'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- APIé…ç½®è¡¨å• -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">äº¤æ˜“æ‰€</label>
                    <select x-model="apiConfig.exchange" @change="onExchangeChange()" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option value="okx">æ¬§æ˜“ (OKX)</option>
                        <option value="binance">å¸å®‰ (Binance)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">äº¤æ˜“æ¨¡å¼</label>
                    <select x-model="apiConfig.testnet" class="w-full border border-gray-300 px-3 py-2 text-sm" :class="apiConfig.testnet ? 'text-blue-600' : 'text-red-600'">
                        <option :value="true">ğŸ§ª æ¨¡æ‹Ÿäº¤æ˜“ï¼ˆæ— é£é™©ï¼‰</option>
                        <option :value="false">ğŸ’ çœŸå®äº¤æ˜“ï¼ˆä½¿ç”¨çœŸé‡‘ç™½é“¶ï¼‰</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">API Key</label>
                    <input type="text" x-model="apiConfig.api_key" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="è¾“å…¥API Key">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">Secret</label>
                    <input type="password" x-model="apiConfig.secret" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="è¾“å…¥Secret">
                </div>
                <div x-show="apiConfig.exchange === 'okx'" class="col-span-2">
                    <label class="text-xs text-gray-600 uppercase block mb-1">Password</label>
                    <input type="password" x-model="apiConfig.password" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="è¾“å…¥Password">
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="testConnection()" :disabled="testingConnection" class="px-4 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:bg-gray-300">
                    <span x-show="!testingConnection">æµ‹è¯•è¿æ¥</span>
                    <span x-show="testingConnection">æµ‹è¯•ä¸­...</span>
                </button>
                <button @click="saveApiConfig()" class="px-4 py-2 bg-black text-white text-sm hover:bg-gray-800">
                    ä¿å­˜é…ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- ç­–ç•¥é…ç½®è¡¨æ ¼ -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold border-b border-black pb-1">ç­–ç•¥é…ç½®</h2>
            <button @click="showAddConfig = true" class="text-sm text-blue-600">+ æ–°å¢ç­–ç•¥</button>
        </div>

        <div x-show="showAddConfig" class="border border-gray-300 p-4 mb-4">
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">äº¤æ˜“æ‰€</label>
                    <select x-model="newConfig.exchange" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option value="okx">æ¬§æ˜“ (OKX)</option>
                        <option value="binance">å¸å®‰ (Binance)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">äº¤æ˜“å¯¹</label>
                    <select x-model="newConfig.symbol" class="w-full border border-gray-300 px-3 py-2 text-sm">
                        <option value="BTC/USDT">BTC/USDT</option>
                        <option value="ETH/USDT">ETH/USDT</option>
                        <option value="BNB/USDT">BNB/USDT</option>
                        <option value="SOL/USDT">SOL/USDT</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">ä¸Šæ¶¨é˜ˆå€¼(%)</label>
                    <input type="number" x-model.number="newConfig.long_threshold" step="0.1" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="2">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">ä¸‹è·Œé˜ˆå€¼(%)</label>
                    <input type="number" x-model.number="newConfig.short_threshold" step="0.1" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="2">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">æ­¢æŸæ¯”ä¾‹(%)</label>
                    <input type="number" x-model.number="newConfig.stop_loss_ratio" step="0.1" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="5">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">æ æ†</label>
                    <input type="number" x-model.number="newConfig.leverage" min="1" max="125" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="1">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">å›ºå®šä»“ä½(USDT)</label>
                    <input type="number" x-model.number="newConfig.position_size" step="10" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="ç•™ç©ºä½¿ç”¨æ¯”ä¾‹">
                </div>
                <div>
                    <label class="text-xs text-gray-600 uppercase block mb-1">ä»“ä½æ¯”ä¾‹(%)</label>
                    <input type="number" x-model.number="newConfig.position_ratio" step="1" min="1" max="100" class="w-full border border-gray-300 px-3 py-2 text-sm" placeholder="20">
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="createConfig()" class="px-4 py-2 bg-black text-white text-sm hover:bg-gray-800">
                    ä¿å­˜ç­–ç•¥
                </button>
                <button @click="showAddConfig = false" class="px-4 py-2 border border-gray-300 text-sm hover:bg-gray-50">
                    å–æ¶ˆ
                </button>
            </div>
        </div>

        <table class="excel-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>äº¤æ˜“æ‰€</th>
                <th>äº¤æ˜“å¯¹</th>
                <th>ä¸Šæ¶¨é˜ˆå€¼</th>
                <th>ä¸‹è·Œé˜ˆå€¼</th>
                <th>æ­¢æŸ</th>
                <th>æ æ†</th>
                <th>ä»“ä½</th>
                <th>ç°ä»·</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="config in configs" :key="config.id">
                <tr>
                    <td x-text="config.id"></td>
                    <td x-text="config.exchange.toUpperCase()"></td>
                    <td x-text="config.symbol"></td>
                    <td x-text="(config.long_threshold * 100).toFixed(1) + '%'"></td>
                    <td x-text="(config.short_threshold * 100).toFixed(1) + '%'"></td>
                    <td x-text="(config.stop_loss_ratio * 100).toFixed(1) + '%'"></td>
                    <td x-text="config.leverage + 'x'"></td>
                    <td>
                        <span x-show="config.position_size" x-text="config.position_size + ' USDT'"></span>
                        <span x-show="!config.position_size" x-text="config.position_ratio + '%'"></span>
                    </td>
                    <td x-text="ticker[config.symbol] || '-'"></td>
                    <td>
                        <button @click="deleteConfig(config.id)" class="text-red-600 hover:underline text-xs">åˆ é™¤</button>
                    </td>
                </tr>
            </template>
            <tr x-show="configs.length === 0">
                <td colspan="11" class="text-center text-gray-400 py-4">æš‚æ— ç­–ç•¥é…ç½®</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- äº¤æ˜“æ§åˆ¶ -->
    <div class="mb-6">
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">äº¤æ˜“æ§åˆ¶</h2>
        <div class="flex gap-4">
            <button @click="controlTrading('start')"
                    :disabled="tradingStatus === 'running'"
                    class="px-6 py-2 bg-green-600 text-white text-sm hover:bg-green-700 disabled:opacity-50">
                å¯åŠ¨äº¤æ˜“
            </button>
            <button @click="controlTrading('pause')"
                    :disabled="tradingStatus !== 'running'"
                    class="px-6 py-2 bg-yellow-600 text-white text-sm hover:bg-yellow-700 disabled:opacity-50">
                æš‚åœäº¤æ˜“
            </button>
            <button @click="controlTrading('resume')"
                    :disabled="tradingStatus !== 'paused'"
                    class="px-6 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-50">
                æ¢å¤äº¤æ˜“
            </button>
            <button @click="controlTrading('stop')"
                    :disabled="tradingStatus === 'stopped'"
                    class="px-6 py-2 bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-50">
                åœæ­¢äº¤æ˜“
            </button>
        </div>
    </div>

    <!-- æŒä»“ç›‘æ§è¡¨æ ¼ -->
    <div class="mb-6">
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">æŒä»“ç›‘æ§</h2>
        <table class="excel-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>äº¤æ˜“å¯¹</th>
                <th>æ–¹å‘</th>
                <th>æ•°é‡</th>
                <th>å…¥åœºä»·</th>
                <th>ç°ä»·</th>
                <th>ç›ˆäº</th>
                <th>ç›ˆäº%</th>
                <th>æ­¢æŸä»·</th>
                <th>å¼€ä»“æ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="pos in positions" :key="pos.id">
                <tr>
                    <td x-text="pos.id"></td>
                    <td x-text="pos.symbol"></td>
                    <td>
                        <span :class="pos.side === 'long' ? 'text-green-600' : 'text-red-600'" x-text="pos.side === 'long' ? 'åšå¤š' : 'åšç©º'"></span>
                    </td>
                    <td x-text="pos.size.toFixed(4)"></td>
                    <td x-text="pos.entry_price.toFixed(2)"></td>
                    <td x-text="pos.current_price.toFixed(2)"></td>
                    <td :class="pos.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="pos.unrealized_pnl.toFixed(2) + ' USDT'"></td>
                    <td :class="pos.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="(pos.unrealized_pnl_pct * 100).toFixed(2) + '%'"></td>
                    <td x-text="pos.stop_loss ? pos.stop_loss.toFixed(2) : '-'"></td>
                    <td x-text="new Date(pos.created_at).toLocaleString()"></td>
                    <td>
                        <button @click="closePosition(pos.id)" class="text-red-600 hover:underline text-xs">å¹³ä»“</button>
                    </td>
                </tr>
            </template>
            <tr x-show="positions.length === 0">
                <td colspan="12" class="text-center text-gray-400 py-4">æš‚æ— æŒä»“</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- äº¤æ˜“å†å²è¡¨æ ¼ -->
    <div class="mb-6">
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">äº¤æ˜“å†å²</h2>
        <table class="excel-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>äº¤æ˜“å¯¹</th>
                <th>æ–¹å‘</th>
                <th>ç±»å‹</th>
                <th>ä»·æ ¼</th>
                <th>æ•°é‡</th>
                <th>ç›ˆäº</th>
                <th>æ‰‹ç»­è´¹</th>
                <th>çŠ¶æ€</th>
                <th>æ—¶é—´</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="trade in trades" :key="trade.id">
                <tr>
                    <td x-text="trade.id"></td>
                    <td x-text="trade.symbol"></td>
                    <td>
                        <span :class="trade.side === 'buy' ? 'text-green-600' : 'text-red-600'" x-text="trade.side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'"></span>
                    </td>
                    <td x-text="trade.order_type"></td>
                    <td x-text="trade.price.toFixed(2)"></td>
                    <td x-text="trade.quantity.toFixed(4)"></td>
                    <td :class="trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="trade.pnl ? trade.pnl.toFixed(2) + ' USDT' : '-'"></td>
                    <td x-text="trade.fee ? trade.fee.toFixed(4) + ' USDT' : '-'"></td>
                    <td>
                        <span x-show="trade.status === 'filled'" class="text-green-600">æˆäº¤</span>
                        <span x-show="trade.status === 'pending'" class="text-yellow-600">å¾…æˆäº¤</span>
                        <span x-show="trade.status === 'cancelled'" class="text-red-600">å·²å–æ¶ˆ</span>
                        <span x-show="trade.status === 'failed'" class="text-red-600">å¤±è´¥</span>
                    </td>
                    <td x-text="new Date(trade.created_at).toLocaleString()"></td>
                </tr>
            </template>
            <tr x-show="trades.length === 0">
                <td colspan="11" class="text-center text-gray-400 py-4">æš‚æ— äº¤æ˜“è®°å½•</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- å¸‚åœºè¡Œæƒ… -->
    <div>
        <h2 class="text-lg font-bold border-b border-black pb-1 mb-2">å¸‚åœºè¡Œæƒ…</h2>

        <!-- æœç´¢æ¡† -->
        <div class="mb-4 flex gap-2">
            <select x-model="searchExchange" @change="loadAvailableSymbols()" class="border border-gray-300 px-3 py-2 text-sm">
                <option value="okx">æ¬§æ˜“ (OKX)</option>
                <option value="binance">å¸å®‰ (Binance)</option>
            </select>
            <div class="relative flex-1">
                <input
                    type="text"
                    x-model="searchSymbol"
                    @keyup.enter="searchTicker()"
                    @focus="showSymbolList = true"
                    placeholder="è¾“å…¥äº¤æ˜“å¯¹åç§°ï¼Œå¦‚: BTC/USDT"
                    class="w-full border border-gray-300 px-3 py-2 text-sm"
                >
                <!-- äº¤æ˜“å¯¹ä¸‹æ‹‰åˆ—è¡¨ -->
                <div x-show="showSymbolList && availableSymbols.length > 0" class="absolute z-10 w-full bg-white border border-gray-300 mt-1 max-h-60 overflow-y-auto">
                    <template x-for="symbol in availableSymbols" :key="symbol">
                        <div
                            @click="selectSymbol(symbol)"
                            class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                            x-text="symbol"
                        ></div>
                    </template>
                </div>
            </div>
            <button @click="searchTicker()" class="px-4 py-2 bg-black text-white text-sm hover:bg-gray-800">
                æœç´¢
            </button>
            <button @click="clearSearch()" class="px-4 py-2 border border-gray-300 text-sm hover:bg-gray-50">
                æ¸…ç©º
            </button>
        </div>

        <!-- æœç´¢ç»“æœæç¤º -->
        <div x-show="searchResult" class="mb-4 p-3 bg-blue-50 border border-blue-200 text-sm">
            <span class="font-bold">æœç´¢ç»“æœï¼š</span>
            <span x-text="searchResult"></span>
        </div>

        <table class="excel-table">
            <thead>
            <tr>
                <th>äº¤æ˜“å¯¹</th>
                <th>æœ€æ–°ä»·</th>
                <th>24hæ¶¨è·Œ</th>
                <th>24hæ¶¨è·Œå¹…</th>
                <th>24hæˆäº¤é‡</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="(ticker, symbol) in marketTicker" :key="symbol">
                <tr>
                    <td x-text="symbol"></td>
                    <td x-text="ticker.price ? ticker.price.toFixed(2) : '-'"></td>
                    <td :class="ticker.change >= 0 ? 'text-green-600' : 'text-red-600'" x-text="ticker.change ? ticker.change.toFixed(2) : '-'"></td>
                    <td :class="ticker.change_percent >= 0 ? 'text-green-600' : 'text-red-600'" x-text="ticker.change_percent ? ticker.change_percent.toFixed(2) + '%' : '-'"></td>
                    <td x-text="ticker.volume ? ticker.volume.toFixed(2) : '-'"></td>
                </tr>
            </template>
            <tr x-show="Object.keys(marketTicker).length === 0">
                <td colspan="5" class="text-center text-gray-400 py-4">æš‚æ— è¡Œæƒ…æ•°æ®</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    function app() {
        return {
            showApiConfig: false,
            showAddConfig: false,
            tradingStatus: 'stopped',
            balance: 0,
            positions: [],
            trades: [],
            configs: [],
            performance: {},
            ticker: {},
            marketTicker: {},
            searchExchange: 'okx',
            searchSymbol: '',
            searchResult: '',
            showSymbolList: false,
            availableSymbols: [],
            connectionStatus: {
                checked: false,
                connected: false,
                message: ''
            },
            accountInfo: null,
            testingConnection: false,
            apiConfig: {
                exchange: 'okx',
                testnet: true,
                api_key: '',
                secret: '',
                password: ''
            },
            newConfig: {
                exchange: 'okx',
                symbol: 'BTC/USDT',
                long_threshold: 2,
                short_threshold: 2,
                stop_loss_ratio: 5,
                leverage: 1,
                position_size: null,
                position_ratio: 20
            },

            init() {
                this.loadConfigs();
                this.loadPerformance();
                this.loadPositions();
                this.loadTrades();
                this.loadBalance();
                this.loadApiConfig();
                this.checkTradingStatus();
                this.loadMarketTicker();
                this.loadAvailableSymbols();
                setInterval(() => this.refreshData(), 5000);
            },

            async loadApiConfig() {
                try {
                    const response = await fetch('/api/exchange/api-config');
                    const data = await response.json();
                    if (data.success && data.config) {
                        this.apiConfig = data.config;
                    }
                } catch (error) {
                    console.error('åŠ è½½APIé…ç½®å¤±è´¥:', error);
                }
            },

            async saveApiConfig() {
                try {
                    const response = await fetch('/api/exchange/api-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.apiConfig)
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('APIé…ç½®ä¿å­˜æˆåŠŸ');
                        this.showApiConfig = false;
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            },

            async testConnection() {
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!this.apiConfig.api_key || !this.apiConfig.secret) {
                    alert('è¯·å¡«å†™API Keyå’ŒSecret');
                    return;
                }

                if (this.apiConfig.exchange === 'okx' && !this.apiConfig.password) {
                    alert('OKXéœ€è¦å¡«å†™Password');
                    return;
                }

                this.testingConnection = true;
                this.connectionStatus.checked = false;

                try {
                    const response = await fetch('/api/exchange/test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.apiConfig)
                    });
                    const data = await response.json();

                    this.connectionStatus.checked = true;
                    this.connectionStatus.connected = data.success;

                    if (data.success) {
                        this.connectionStatus.message = 'è¿æ¥æˆåŠŸï¼å·²è·å–è´¦æˆ·ä¿¡æ¯';
                        this.accountInfo = {
                            balance: data.balance,
                            total_equity: data.total_equity || null,
                            unrealized_pnl: data.unrealized_pnl || null
                        };
                    } else {
                        this.connectionStatus.message = 'è¿æ¥å¤±è´¥ï¼š' + data.message;
                        this.accountInfo = null;
                    }
                } catch (error) {
                    this.connectionStatus.checked = true;
                    this.connectionStatus.connected = false;
                    this.connectionStatus.message = 'è¿æ¥å¤±è´¥ï¼š' + error.message;
                    this.accountInfo = null;
                } finally {
                    this.testingConnection = false;
                }
            },

            async loadConfigs() {
                try {
                    const response = await fetch('/api/strategy/configs');
                    const data = await response.json();
                    if (data.success) {
                        this.configs = data.configs;
                        if (this.configs.length > 0) {
                            this.loadTicker();
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                }
            },

            async loadPerformance() {
                try {
                    const response = await fetch('/api/performance');
                    const data = await response.json();
                    if (data.success) {
                        this.performance = data.performance;
                    }
                } catch (error) {
                    console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
                }
            },

            async loadPositions() {
                try {
                    const response = await fetch('/api/positions');
                    const data = await response.json();
                    if (data.success) {
                        this.positions = data.positions;
                    }
                } catch (error) {
                    console.error('åŠ è½½æŒä»“å¤±è´¥:', error);
                }
            },

            async loadTrades() {
                try {
                    const response = await fetch('/api/trades?limit=50');
                    const data = await response.json();
                    if (data.success) {
                        this.trades = data.trades;
                    }
                } catch (error) {
                    console.error('åŠ è½½äº¤æ˜“å†å²å¤±è´¥:', error);
                }
            },

            async loadBalance() {
                try {
                    if (this.configs.length > 0) {
                        const response = await fetch(`/api/exchange/balance/${this.configs[0].exchange}`);
                        const data = await response.json();
                        if (data.success && data.balance.USDT) {
                            this.balance = data.balance.USDT.free;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ä½™é¢å¤±è´¥:', error);
                }
            },

            async loadTicker() {
                for (const config of this.configs) {
                    try {
                        const response = await fetch(`/api/exchange/ticker/${config.exchange}/${config.symbol}`);
                        const data = await response.json();
                        if (data.success) {
                            this.ticker[config.symbol] = data.price;
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¡Œæƒ…å¤±è´¥:', error);
                    }
                }
            },

            async loadMarketTicker() {
                const symbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT'];
                for (const symbol of symbols) {
                    try {
                        const response = await fetch(`/api/exchange/ticker/okx/${symbol}`);
                        const data = await response.json();
                        if (data.success && data.ticker) {
                            this.marketTicker[symbol] = {
                                price: data.ticker.last,
                                change: data.ticker.change,
                                change_percent: data.ticker.percentage,
                                volume: data.ticker.volume
                            };
                        }
                    } catch (error) {
                        console.error('åŠ è½½å¸‚åœºè¡Œæƒ…å¤±è´¥:', error);
                    }
                }
            },

            async searchTicker() {
                if (!this.searchSymbol.trim()) {
                    alert('è¯·è¾“å…¥äº¤æ˜“å¯¹åç§°');
                    return;
                }

                try {
                    const response = await fetch(`/api/exchange/ticker/${this.searchExchange}/${this.searchSymbol}`);
                    const data = await response.json();

                    if (data.success && data.ticker) {
                        // æ¸…ç©ºç°æœ‰è¡Œæƒ…
                        this.marketTicker = {};

                        // æ˜¾ç¤ºæœç´¢ç»“æœ
                        this.marketTicker[this.searchSymbol] = {
                            price: data.ticker.last,
                            change: data.ticker.change,
                            change_percent: data.ticker.percentage,
                            volume: data.ticker.volume
                        };

                        this.searchResult = `æˆåŠŸè·å– ${this.searchSymbol} è¡Œæƒ…æ•°æ®`;
                    } else {
                        this.searchResult = `æœç´¢å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                        alert('æœç´¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    this.searchResult = `æœç´¢å‡ºé”™: ${error.message}`;
                    alert('æœç´¢å‡ºé”™: ' + error.message);
                }
            },

            clearSearch() {
                this.searchSymbol = '';
                this.searchResult = '';
                this.loadMarketTicker();
            },

            async loadAvailableSymbols() {
                try {
                    const response = await fetch(`/api/exchange/symbols/${this.searchExchange}`);
                    const data = await response.json();
                    if (data.success) {
                        this.availableSymbols = data.symbols || [];
                        if (data.note) {
                            console.log(data.note);
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨å¤±è´¥:', error);
                }
            },

            selectSymbol(symbol) {
                this.searchSymbol = symbol;
                this.showSymbolList = false;
            },

            async checkTradingStatus() {
                try {
                    const response = await fetch('/api/trading/status');
                    const data = await response.json();
                    if (data.success) {
                        this.tradingStatus = data.status;
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥äº¤æ˜“çŠ¶æ€å¤±è´¥:', error);
                }
            },

            onExchangeChange() {
                // åˆ‡æ¢äº¤æ˜“æ‰€æ—¶ï¼Œæ¸…ç©ºè¿æ¥çŠ¶æ€
                this.connectionStatus = {
                    checked: false,
                    connected: false,
                    message: ''
                };
                this.accountInfo = null;
            },

            async createConfig() {
                try {
                    const config = {
                        ...this.newConfig,
                        long_threshold: this.newConfig.long_threshold / 100,
                        short_threshold: this.newConfig.short_threshold / 100,
                        stop_loss_ratio: this.newConfig.stop_loss_ratio / 100
                    };

                    const response = await fetch('/api/strategy/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('ç­–ç•¥ä¿å­˜æˆåŠŸ');
                        this.showAddConfig = false;
                        this.loadConfigs();
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            },

            async deleteConfig(id) {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç­–ç•¥å—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`/api/strategy/config/${id}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('åˆ é™¤æˆåŠŸ');
                        this.loadConfigs();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            },

            async closePosition(id) {
                if (!confirm('ç¡®å®šå¹³ä»“å—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`/api/positions/${id}/close`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('å¹³ä»“æˆåŠŸ');
                        this.loadPositions();
                        this.loadTrades();
                        this.loadPerformance();
                    } else {
                        alert('å¹³ä»“å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('å¹³ä»“å¤±è´¥: ' + error.message);
                }
            },

            async controlTrading(action) {
                try {
                    const response = await fetch('/api/trading/control', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ action })
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert(data.message);
                        this.checkTradingStatus();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    alert('æ“ä½œå¤±è´¥: ' + error.message);
                }
            },

            refreshData() {
                this.loadPositions();
                this.loadTrades();
                this.loadPerformance();
                this.loadBalance();
                this.loadTicker();
                // åªåœ¨æ²¡æœ‰æœç´¢æ—¶è‡ªåŠ¨åˆ·æ–°å¸‚åœºè¡Œæƒ…
                if (!this.searchSymbol) {
                    this.loadMarketTicker();
                }
                this.checkTradingStatus();
            }
        };
    }
</script>

</body>
</html>
