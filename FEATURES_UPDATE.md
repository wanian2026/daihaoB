# 新功能更新说明

## 更新日期
2025年

## 新增功能

### 1. 杠杆交易支持
- **功能描述**: 支持设置杠杆倍数（1-125倍）
- **实现方式**:
  - 数据模型中添加 `leverage` 字段
  - 交易引擎中根据杠杆计算实际持仓数量
  - 配置界面支持杠杆输入

### 2. 动态开仓比例
- **功能描述**: 支持两种开仓模式
  - **固定仓位模式**: 每次开固定USDT金额的仓位
  - **比例开仓模式**: 每次开仓根据当前账户余额动态计算（如每次开10%）
- **实现方式**:
  - 策略配置表中添加 `position_ratio` 字段
  - 交易引擎中动态获取当前余额并计算开仓数量
  - 配置界面支持选择两种模式
  - 交易成本计算支持两种模式

### 3. 独立止损设置
- **功能描述**: 每个仓位可以单独设置止损价格
- **实现方式**:
  - 仓位表中添加 `stop_loss_price` 字段
  - 交易引擎中优先使用独立止损价格，否则使用默认止损比例
  - 支持通过 `PositionManager.set_stop_loss()` 方法更新止损价格

## 数据库表结构变更

### positions 表（仓位表）
新增字段：
- `leverage` (Integer): 杠杆倍数，默认1
- `stop_loss_price` (Float): 独立止损价格（可选）
- `initial_balance` (Float): 开仓时的账户余额（用于记录）

### strategy_configs 表（策略配置表）
新增字段：
- `position_ratio` (Float, 可选): 开仓比例（0-1之间）
- `position_size` (Float, 可选): 固定仓位大小（USDT）

## 使用说明

### 配置策略参数

在交互式配置界面中，现在可以选择：

1. **上涨阈值**: 触发多单平仓/开新单的价格百分比
2. **下跌阈值**: 触发空单平仓/开新单的价格百分比
3. **默认止损比例**: 默认止损百分比（可被独立止损覆盖）
4. **仓位模式选择**:
   - 固定仓位：输入固定的USDT金额
   - 按比例开仓：输入开仓比例（如0.1表示10%）
5. **杠杆倍数**: 输入杠杆倍数（1-125）
6. **监控间隔**: 价格检查间隔（秒）

### 示例配置

#### 固定仓位模式
```
上涨阈值: 2%
下跌阈值: 2%
默认止损比例: 5%
仓位模式: 固定仓位
仓位大小: 1000 USDT
杠杆倍数: 5x
```

每次开仓固定使用1000 USDT，5倍杠杆。

#### 比例开仓模式
```
上涨阈值: 2%
下跌阈值: 2%
默认止损比例: 5%
仓位模式: 按比例开仓
开仓比例: 10%
杠杆倍数: 5x
```

假设当前账户余额为10000 USDT：
- 第一次开仓：10000 * 10% = 1000 USDT
- 假设盈利后余额变为12000 USDT
- 第二次开仓：12000 * 10% = 1200 USDT

### 独立止损设置

可以在策略运行后为特定仓位设置独立止损价格：

```python
from storage.database.position_manager import PositionManager
from storage.database.db import get_session

db = get_session()
position_mgr = PositionManager()

# 为仓位ID为1的仓位设置独立止损价格
position_mgr.set_stop_loss(db, 1, 49500.0)

db.close()
```

## 测试

运行测试脚本验证功能：

```bash
export PYTHONPATH=/workspace/projects/src:$PYTHONPATH
python scripts/test_new_features.py
```

测试内容包括：
1. 仓位模型新字段测试
2. 策略配置模型新字段测试
3. 交易成本计算测试（固定仓位和比例开仓两种模式）

## 注意事项

1. **风险控制**: 杠杆交易会放大收益和风险，请谨慎设置杠杆倍数
2. **资金管理**: 比例开仓模式可以随着盈利增加仓位，但也可能导致亏损时仓位缩小
3. **止损优先级**: 
   - 如果设置了独立止损价格，优先使用独立止损
   - 否则使用默认止损比例
4. **保证金**: 使用杠杆会降低所需保证金，但也会放大风险

## 后续优化建议

1. 添加仓位管理界面，支持查看和修改每个仓位的独立止损
2. 添加风险计算功能，显示当前风险敞口
3. 支持分批开仓/平仓
4. 添加历史回测功能，验证策略效果
